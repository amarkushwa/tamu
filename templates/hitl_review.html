{% extends "base.html" %}

{% block title %}Review Document - Torpe Hitachi Classifier - Web UI{% endblock %}

{% block extra_styles %}
<style>
    .review-container {
        max-width: 960px;
        margin: 0 auto;
    }

    .document-info {
        background: linear-gradient(135deg, var(--light-gray) 0%, white 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border);
        transition: all 0.2s;
    }

    .info-row:hover {
        background: rgba(99, 102, 241, 0.03);
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        margin: 0 -0.5rem;
        border-radius: 8px;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: var(--gray);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        color: var(--dark);
        text-align: right;
        font-weight: 500;
    }

    .info-value code {
        background: var(--light-gray);
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.875em;
    }

    .review-form {
        background: white;
        border: 2px solid var(--primary);
        border-radius: 20px;
        padding: 2.5rem;
        margin-top: 2rem;
        box-shadow: var(--shadow-lg);
    }

    .review-form h3 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .review-form h3::before {
        content: '‚úèÔ∏è';
        font-size: 1.75rem;
    }

    .review-form > p {
        color: var(--gray);
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .form-group {
        margin-bottom: 1.75rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.625rem;
        font-size: 0.9rem;
    }

    .form-select {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.3s;
        background: white;
        cursor: pointer;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-textarea {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        min-height: 120px;
        transition: all 0.3s;
        line-height: 1.6;
    }

    .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-input {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--gray) 0%, #4b5563 100%);
    }

    #successMessage {
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="review-container">
    <h2>üìù Document Review</h2>

    <div class="document-info">
        <div class="info-row">
            <span class="info-label">Document ID</span>
            <span class="info-value"><code>{{ classification.document_id }}</code></span>
        </div>
        <div class="info-row">
            <span class="info-label">File Name</span>
            <span class="info-value">{{ classification.file_name }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">AI Classification</span>
            <span class="info-value">
                <span class="badge badge-{{ classification.final_category.lower() }}">
                    {{ classification.final_category }}
                </span>
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">Confidence Score</span>
            <span class="info-value">{{ "%.1f"|format(classification.confidence_score * 100) }}%</span>
        </div>
        <div class="info-row">
            <span class="info-label">Reasoning</span>
            <span class="info-value">{{ classification.reasoning_summary }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Citation</span>
            <span class="info-value">{{ classification.citation_snippet }}</span>
        </div>
        {% if classification.blockchain_tx_hash %}
        <div class="info-row">
            <span class="info-label">Blockchain Audit</span>
            <span class="info-value">
                <code>{{ classification.blockchain_tx_hash[:32] }}...</code>
            </span>
        </div>
        {% endif %}
    </div>

    <div class="review-form">
        <h3>SME Review</h3>
        <p style="color: #666; margin-bottom: 20px;">
            Review the AI classification and provide corrections if needed.
        </p>

        <form id="reviewForm">
            <input type="hidden" id="documentId" value="{{ classification.document_id }}">

            <div class="form-group">
                <label class="form-label" for="correctedCategory">Corrected Classification</label>
                <select id="correctedCategory" class="form-select" required>
                    <option value="">-- Select Category --</option>
                    <option value="UNSAFE" {% if classification.final_category == 'UNSAFE' %}selected{% endif %}>UNSAFE</option>
                    <option value="CONFIDENTIAL" {% if classification.final_category == 'CONFIDENTIAL' %}selected{% endif %}>CONFIDENTIAL</option>
                    <option value="SENSITIVE" {% if classification.final_category == 'SENSITIVE' %}selected{% endif %}>SENSITIVE</option>
                    <option value="PUBLIC" {% if classification.final_category == 'PUBLIC' %}selected{% endif %}>PUBLIC</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="reviewerName">Reviewer Name</label>
                <input type="text" id="reviewerName" class="form-input" value="SME" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="reviewNotes">Review Notes</label>
                <textarea id="reviewNotes" class="form-textarea"
                    placeholder="Explain your reasoning if you're correcting the classification..."></textarea>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-success">‚úÖ Submit Review</button>
                <a href="/hitl/queue" class="btn btn-secondary">‚Üê Back to Queue</a>
            </div>
        </form>
    </div>

    <div id="successMessage" class="alert alert-success" style="display: none; margin-top: 1.5rem;">
        ‚úÖ Review submitted successfully! Redirecting to queue...
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('reviewForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const data = {
        document_id: document.getElementById('documentId').value,
        corrected_category: document.getElementById('correctedCategory').value,
        reviewer_name: document.getElementById('reviewerName').value,
        notes: document.getElementById('reviewNotes').value
    };

    fetch('/hitl/submit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById('successMessage').style.display = 'block';
            setTimeout(() => {
                window.location.href = '/hitl/queue';
            }, 2000);
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error submitting review: ' + error);
    });
});
</script>
{% endblock %}
